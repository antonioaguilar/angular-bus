(function(e,t){e.pubsub=t(e._,e)})(this,function(e,t,i){var n={DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"SYS",enableSystemMessages:false,cacheKeyDelimiter:"|",autoCompactResolver:false};var r={configuration:e.extend({},n)};var c=r.configuration;var s=function(e,t){this.bus=t;this.channel=e||c.DEFAULT_CHANNEL};s.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:arguments.length===1?arguments[0].topic:arguments[0],callback:arguments.length===1?arguments[0].callback:arguments[1]})};s.prototype.publish=function(){var e={};var t;if(typeof arguments[0]==="string"){e.topic=arguments[0];e.data=arguments[1];t=arguments[2]}else{e=arguments[0];t=arguments[1]}if(typeof e!=="object"){throw new Error("The first argument to ChannelDefinition.publish should be either an envelope object or a string topic.")}e.channel=this.channel;this.bus.publish(e,t)};var a=function(e,t,n){if(arguments.length!==3){throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.")}if(t.length===0){throw new Error("Topics cannot be empty")}this.channel=e;this.topic=t;this.callback=n;this.pipeline=[];this.cacheKeys=[];this._context=i};var u=function(){var t;return function(i){var n=false;if(typeof i==="string"){n=i===t;t=i}else{n=e.isEqual(i,t);t=e.extend({},i)}return!n}};var o=function t(){var i=[];return function t(n){var r=!e.some(i,function(t){return e.isEqual(n,t)});if(r){i.push(n)}return r}};a.prototype={catch:function(e){var t=this.callback;this.callback=function(){try{t.apply(this,arguments)}catch(t){e(t,arguments[0])}};return this},defer:function e(){return this.delay(0)},disposeAfter:function t(i){if(typeof i!=="number"||i<=0){throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.")}var n=this;var r=e.after(i,e.bind(function(){n.unsubscribe()}));n.pipeline.push(function(e,t,i){i(e,t);r()});return n},distinct:function e(){return this.constraint(new o)},distinctUntilChanged:function e(){return this.constraint(new u)},invokeSubscriber:function e(t,i){if(!this.inactive){var n=this;var r=n.pipeline;var c=r.length;var s=n._context;var a=-1;var u=false;if(!c){n.callback.call(s,t,i);u=true}else{r=r.concat([n.callback]);var o=function e(t,i){a+=1;if(a<c){r[a].call(s,t,i,e)}else{n.callback.call(s,t,i);u=true}};o(t,i,0)}return u}},once:function e(){return this.disposeAfter(1)},subscribe:function e(t){this.callback=t;return this},unsubscribe:function e(){if(!this.inactive){r.unsubscribe(this)}},constraint:function e(t){if(typeof t!=="function"){throw new Error("Predicate constraint must be a function")}this.pipeline.push(function(e,i,n){if(t.call(this,e,i)){n(e,i)}});return this},constraints:function t(i){var n=this;e.each(i,function(e){n.constraint(e)});return n},context:function e(t){this._context=t;return this},debounce:function t(i,n){if(typeof i!=="number"){throw new Error("Milliseconds must be a number")}this.pipeline.push(e.debounce(function(e,t,i){i(e,t)},i,!!n));return this},delay:function e(t){if(typeof t!=="number"){throw new Error("Milliseconds must be a number")}var i=this;i.pipeline.push(function(e,i,n){setTimeout(function(){n(e,i)},t)});return this},throttle:function t(i){if(typeof i!=="number"){throw new Error("Milliseconds must be a number")}var n=function(e,t,i){i(e,t)};this.pipeline.push(e.throttle(n,i));return this}};var h=c.resolver={cache:{},regex:{},enableCache:true,compare:function t(i,n,r){var s;var a;var u;var o=n+c.cacheKeyDelimiter+i;var h=this.cache[o];var f=r||{};var l=this.enableCache&&!f.resolverNoCache;if(h===true){return h}if(i.indexOf("#")===-1&&i.indexOf("*")===-1){h=n===i;if(l){this.cache[o]=h}return h}if(!(a=this.regex[i])){s="^"+e.map(i.split("."),function e(t){var i="";if(!!u){i=u!=="#"?"\\.\\b":"\\b"}if(t==="#"){i+="[\\s\\S]*"}else if(t==="*"){i+="[^.]+"}else{i+=t}u=t;return i}).join("")+"$";a=this.regex[i]=new RegExp(s)}h=a.test(n);if(l){this.cache[o]=h}return h},reset:function e(){this.cache={};this.regex={}},purge:function(t){var i=this;var n=c.cacheKeyDelimiter;var s=function(e,r){var c=r.split(n);var s=c[0];var a=c[1];if((typeof t.topic==="undefined"||t.topic===s)&&(typeof t.binding==="undefined"||t.binding===a)){delete i.cache[r]}};var a=function(e,t){var c=t.split(n);if(r.getSubscribersFor({topic:c[0]}).length===0){delete i.cache[t]}};if(typeof t==="undefined"){this.reset()}else{var u=t.compact===true?a:s;e.each(this.cache,u)}}};var f=0;var l=[];var b=0;function p(){while(l.length){r.unsubscribe(l.shift())}}function v(e,t,i){return function(n,r,c){if(n===e){c.splice(r,1)}if(c.length===0){delete i[t]}}}function d(e,t,i,n,r){var s=r&&r.headers||{};return function(t){if(c.resolver.compare(t.topic,e,s)){t.cacheKeys.push(i);if(n){n(t)}}}}function g(e,t){return{channel:c.SYSTEM_CHANNEL,topic:"subscription."+e,data:{event:"subscription."+e,channel:t.channel,topic:t.topic}}}var m=e.bind(g,this,"created");var y=e.bind(g,this,"removed");function w(t,i){if(typeof t==="function"){return t}else if(!t){return function(){return true}}else{return function(n){var r=0;var c=0;e.each(t,function(e,s){r+=1;if(s==="topic"&&i.compare(n.topic,t.topic,{resolverNoCache:true})||s==="context"&&t.context===n._context||n[s]===t[s]){c+=1}});return r===c}}}e.extend(r,{cache:{},subscriptions:{},wireTaps:[],ChannelDefinition:s,SubscriptionDefinition:a,channel:function e(t){return new s(t,this)},addWireTap:function e(t){var i=this;i.wireTaps.push(t);return function(){var e=i.wireTaps.indexOf(t);if(e!==-1){i.wireTaps.splice(e,1)}}},getSubscribersFor:function t(i){var n=[];var r=this;e.each(r.subscriptions,function(t){e.each(t,function(t){n=n.concat(e.filter(t,w(i,c.resolver)))})});return n},publish:function t(i,n){++f;i.timestamp=(new Date).toISOString();var r=i.channel=i.channel||c.DEFAULT_CHANNEL;var s=i.topic;if(this.wireTaps.length){e.each(this.wireTaps,function(e){e(i.data,i,f)})}var a=r+c.cacheKeyDelimiter+s;var u=0;var o=0;var h=this.cache[a];if(!h){var l=d(s,this.cache,a,function(e){if(e.invokeSubscriber(i.data,i)){o++}else{u++}},i);e.each(this.subscriptions[r],function(t){e.each(t,l)})}else{e.each(h,function(e){if(e.invokeSubscriber(i.data,i)){o++}else{u++}})}if(--f===0){p()}if(n){n({activated:o,skipped:u})}},subscribe:function t(i){var n=this.subscriptions;var r=new a(i.channel||c.DEFAULT_CHANNEL,i.topic,i.callback);var s=n[r.channel];var u=r.channel.length;var o;if(!s){s=n[r.channel]={}}o=n[r.channel][r.topic];if(!o){o=n[r.channel][r.topic]=[]}o.push(r);e.each(e.keys(this.cache),function(e){if(e.substr(0,u)===r.channel){d(e.split(c.cacheKeyDelimiter)[1],this.cache,e)(r)}},this);if(c.enableSystemMessages){this.publish(m(r))}return r},unsubscribe:function t(){var i=arguments.length;var n=0;var r;var s;var a;var u;for(;n<i;n++){r=arguments[n];r.inactive=true;if(f){l.push(r);return}s=this.subscriptions[r.channel];a=s&&s[r.topic];if(a){var o=a.length;u=0;while(u<o){if(a[u]===r){a.splice(u,1);break}u+=1}if(a.length===0){delete s[r.topic];if(!e.keys(s).length){delete this.subscriptions[r.channel]}}if(r.cacheKeys&&r.cacheKeys.length){var h;while(h=r.cacheKeys.pop()){e.each(this.cache[h],v(r,h,this.cache))}}if(typeof c.resolver.purge==="function"){var p=c.autoCompactResolver===true?0:typeof c.autoCompactResolver==="number"?c.autoCompactResolver-1:false;if(p>=0&&b===p){c.resolver.purge({compact:true});b=0}else if(p>=0&&b<p){b+=1}}}if(c.enableSystemMessages){this.publish(y(r))}}},reset:function e(){this.unsubscribeFor();c.resolver.reset();this.subscriptions={};this.cache={}},unsubscribeFor:function e(t){var i=[];if(this.subscriptions){i=this.getSubscribersFor(t);this.unsubscribe.apply(this,i)}}});var S=function(t,n,c,s){var a=this;var u=Object.prototype.toString.call(c)==="[object Function]"?c:function(){};var o=Object.prototype.toString.call(c)==="[object Object]"?c:s||{};var h=[];var f;var l=function(){if(o.timeout){f=setTimeout(function(){u({type:"timeout",data:e.map(h,"data")})},o.timeout)}};var b=function(){e.each(h,function(e){e.data=i})};var p=function(){var t=e.map(h,"data");if(e.every(t,e.identity)){clearTimeout(f);n.apply(this,t);if(o.once){a.dispose()}else{b();l()}}};a.dispose=function(){e.each(h,function(e){e.unsubscribe()});h=[]};e.each(t,function(e){var t=r.subscribe(e);t.data=i;t.subscribe(function(e){t.data=e;p()});h.push(t)});l()};r.when=function(e,t,i,n){return new S(e,t,i,n)};return r});(function(){angular.module("ngBus",[]).config(["$provide",function(e){e.decorator("$rootScope",["$delegate",function(e){Object.defineProperty(e.constructor.prototype,"$event",{get:function(){var e=this;return{when:pubsub.when.bind(pubsub),channel:pubsub.publish.bind(pubsub),publish:pubsub.publish.bind(pubsub),subscribe:function(){var t=pubsub.subscribe.apply(pubsub,arguments);e.$on("$destroy",function(){t.unsubscribe()});return t},subscriptions:pubsub.subscriptions,getSubscribersFor:pubsub.getSubscribersFor.bind(pubsub),unsubscribeFor:pubsub.unsubscribeFor.bind(pubsub),addWireTap:pubsub.addWireTap.bind(pubsub),reset:pubsub.reset}},enumerable:false});return e}])}])})();